version: "3.9"

services:
  web:
    build: .
    container_name: shoppingmall_web
    env_file:
      - .env
    environment:
      DJANGO_DEBUG: "False"
      # 배포 도메인/IP 반영
      DJANGO_ALLOWED_HOSTS: "hyunhan.shop,www.hyunhan.shop,100.26.164.24"
      # CSRF 신뢰 도메인 (스킴 포함)
      DJANGO_CSRF_TRUSTED_ORIGINS: "https://hyunhan.shop,https://www.hyunhan.shop"
      # 외부 DB 사용: .env 파일의 DATABASE_URL 우선 적용됨
      PORT: "8080"
    command: ["/bin/sh", "-lc", "python manage.py migrate --noinput && python manage.py collectstatic --noinput || true && exec gunicorn config.wsgi:application --bind 0.0.0.0:8080 --workers 3 --timeout 120"]
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media

  nginx:
    image: nginx:1.25-alpine
    container_name: shoppingmall_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - static_volume:/static:ro
      - media_volume:/media:ro
      - roopangshoppingmall_certbot-www:/var/www/certbot:ro
      - roopangshoppingmall_certbot-etc:/etc/letsencrypt:ro
    depends_on:
      - web

  certbot:
    image: certbot/certbot:latest
    container_name: shoppingmall_certbot
    volumes:
      - roopangshoppingmall_certbot-www:/var/www/certbot
      - roopangshoppingmall_certbot-etc:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'while true; do sleep 12h; done'"

volumes:
  static_volume:
  media_volume:
  roopangshoppingmall_certbot-www:
    external: true
  roopangshoppingmall_certbot-etc:
    external: true

  
  
  
  
  
  
  

